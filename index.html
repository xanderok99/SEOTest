import React, { useState } from "react";
import { Input } from "@/components/ui/input";
import { Button } from "@/components/ui/button";
import { Card, CardContent } from "@/components/ui/card";
import { Tabs, TabsContent, TabsList, TabsTrigger } from "@/components/ui/tabs";
import { Textarea } from "@/components/ui/textarea";
import { cn } from "@/lib/utils";
import Papa from "papaparse";

export default function Component() {
  const [csvData, setCsvData] = useState<Record<string, Set<string>>>({});
  const [manualInputs, setManualInputs] = useState<Record<string, string>>({});
  const [filterType, setFilterType] = useState("similar");
  const [filterResult, setFilterResult] = useState<string[]>([]);
  const [activeTab, setActiveTab] = useState("Website 1");
  const [customNames, setCustomNames] = useState<string[]>([]);

  const handleCsvUpload = (event: React.ChangeEvent<HTMLInputElement>) => {
    const files = event.target.files;
    if (!files) return;

    const newCsvData = { ...csvData };
    const newCustomNames = [...customNames];

    Array.from(files).forEach((file, index) => {
      Papa.parse(file, {
        complete: (result) => {
          const urls = new Set(
            result.data
              .flat()
              .map((url: any) => String(url).trim())
              .filter(Boolean)
          );
          const label = `Website ${Object.keys(newCsvData).length + 1}`;
          newCsvData[label] = urls;
          newCustomNames.push(label);
          setCsvData({ ...newCsvData });
          setCustomNames([...newCustomNames]);
        },
      });
    });
  };

  const handleManualChange = (label: string, value: string) => {
    const urls = new Set(
      value
        .split("\n")
        .map((url) => url.trim())
        .filter(Boolean)
    );
    setCsvData((prev) => ({ ...prev, [label]: urls }));
    setManualInputs((prev) => ({ ...prev, [label]: value }));
  };

  const filterSimilarDomains = () => {
    const allUrls = Object.values(csvData);
    const intersection = allUrls.reduce((a, b) => {
      return new Set([...a].filter((url) => b.has(url)));
    });
    setFilterResult([...intersection]);
  };

  const filterUnsimilarWithinBrand = (label: string) => {
    const otherUrls = Object.entries(csvData)
      .filter(([key]) => key !== label)
      .flatMap(([_, urls]) => [...urls]);
    const otherSet = new Set(otherUrls);
    const unsimilar = [...(csvData[label] || [])].filter(
      (url) => !otherSet.has(url)
    );
    setFilterResult(unsimilar);
  };

  const filterAllUnsimilar = () => {
    const allEntries = Object.entries(csvData);
    const allUrls = allEntries.flatMap(([_, urls]) => [...urls]);
    const urlCount: Record<string, number> = {};

    allUrls.forEach((url) => {
      urlCount[url] = (urlCount[url] || 0) + 1;
    });

    const uniqueUrls = Object.entries(urlCount)
      .filter(([_, count]) => count === 1)
      .map(([url]) => url);

    setFilterResult(uniqueUrls);
  };

  const handleFilter = () => {
    if (filterType === "similar") filterSimilarDomains();
    else if (filterType === "unsimilar-all") filterAllUnsimilar();
    else filterUnsimilarWithinBrand(filterType);
  };

  const brandTabs = Object.keys(csvData);

  return (
    <div className="p-6 space-y-8 text-sm">
      <h2 className="text-xl font-bold text-blue-700">ğŸ” Backlink Domain Comparator</h2>

      <Input
        type="file"
        multiple
        accept=".csv"
        onChange={handleCsvUpload}
        className="mb-4"
      />

      <Tabs defaultValue={activeTab} value={activeTab} onValueChange={setActiveTab}>
        <TabsList className="flex flex-wrap gap-2">
          {brandTabs.map((label, index) => (
            <TabsTrigger key={label} value={label}>
              {customNames[index] || label}
            </TabsTrigger>
          ))}
        </TabsList>

        {brandTabs.map((label) => (
          <TabsContent key={label} value={label}>
            <Card>
              <CardContent className="p-4 space-y-2">
                <h3 className="font-semibold text-blue-600">Manual Table Input ({label})</h3>
                <Textarea
                  rows={6}
                  value={manualInputs[label] || ""}
                  onChange={(e) => handleManualChange(label, e.target.value)}
                  placeholder="Paste full sheet (one column) or multiple URLs..."
                />
              </CardContent>
            </Card>
          </TabsContent>
        ))}
      </Tabs>

      <div className="space-y-3">
        <label className="block font-medium text-blue-800">ğŸ”§ Choose Filter</label>
        <select
          className="w-full border rounded p-2"
          value={filterType}
          onChange={(e) => setFilterType(e.target.value)}
        >
          <option value="similar">ğŸ” Similar Domains across all</option>
          {brandTabs.map((label) => (
            <option key={label} value={label}>
              ğŸš« Unsimilar Domains on {label}
            </option>
          ))}
          <option value="unsimilar-all">ğŸš¨ Unsimilar Domains across ALL Brands</option>
        </select>
        <Button onClick={handleFilter}>Apply Filter</Button>
      </div>

      {filterResult.length > 0 && (
        <div className="mt-6">
          <h4 className="text-lg font-semibold text-blue-700 mb-2">ğŸ¯ Filter Results</h4>
          <div className="overflow-auto">
            <table className="min-w-full text-left border border-blue-200">
              <thead className="bg-blue-100">
                <tr>
                  <th className="border px-4 py-2">Domain URL</th>
                </tr>
              </thead>
              <tbody>
                {filterResult.map((url, i) => (
                  <tr key={i}>
                    <td className="border px-4 py-1 text-sm">{url}</td>
                  </tr>
                ))}
              </tbody>
            </table>
          </div>
        </div>
      )}

      <footer className="text-center text-xs text-blue-600 pt-10 border-t border-blue-100">
        ğŸ”¹ Built with â¤ï¸ for backlink data comparison â€¢ v1.0
      </footer>
    </div>
  );
}
